<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X O Game Online - Mobile & Top 100</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #ff0055; --secondary: #00d2ff; --bg: #1a1a2e; --glass: rgba(255, 255, 255, 0.1); }
        
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0; 
            background: url('https://images.unsplash.com/photo-1614726365723-49cfae967d68?q=80&w=2000') center/cover fixed;
            color: white; 
            height: 100vh; 
            overflow: hidden; /* ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å */
            touch-action: manipulation; /* ‡∏•‡∏î‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        }

        .overlay { position: fixed; inset: 0; background: rgba(15, 15, 25, 0.9); z-index: -1; }
        
        /* Screen Management */
        .screen { 
            display: none; 
            height: 100%; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            overflow-y: auto; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞ */
            padding: 20px;
            box-sizing: border-box;
            animation: fade 0.3s;
        }
        .active { display: flex; }
        @keyframes fade { from {opacity:0} to {opacity:1} }

        /* UI Components */
        .btn { 
            padding: 12px 25px; 
            font-size: 18px; 
            border: none; 
            border-radius: 50px; 
            cursor: pointer; 
            transition: 0.2s; 
            font-weight: bold; 
            margin: 8px; 
            width: 80%; /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-p { background: linear-gradient(45deg, var(--primary), #ff5e00); color: white; box-shadow: 0 5px 15px rgba(255,0,85,0.4); }
        .btn-s { background: linear-gradient(45deg, var(--secondary), #0066ff); color: white; box-shadow: 0 5px 15px rgba(0,210,255,0.4); }
        .btn-gold { background: linear-gradient(45deg, #ffd700, #ffaa00); color: #000; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4); }
        .btn:active { transform: scale(0.95); }

        /* Navbar */
        .navbar { 
            position: absolute; 
            top: 0; 
            width: 100%; 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-sizing: border-box; 
            z-index: 10;
        }
        .profile { display: flex; align-items: center; gap: 10px; }
        .profile img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
        .stats { 
            display: flex; gap: 10px; 
            background: rgba(0,0,0,0.6); 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-size: 14px;
        }

        /* Game Board (Responsive) */
        .board { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            width: 100%; 
            max-width: 350px; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏° */
            aspect-ratio: 1/1; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™‡πÄ‡∏™‡∏°‡∏≠ */
            margin: 20px auto;
        }
        .cell { 
            background: var(--glass); 
            border-radius: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 10vw, 60px); /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏à‡∏≠ */
            cursor: pointer; 
            box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
        }
        .cell.x { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .cell.o { color: var(--secondary); text-shadow: 0 0 10px var(--secondary); }

        /* Lobby & Inputs */
        .lobby-box { 
            background: var(--glass); 
            padding: 20px; 
            border-radius: 20px; 
            backdrop-filter: blur(10px); 
            width: 90%; 
            max-width: 600px;
            display: flex; 
            flex-direction: row; /* ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
            justify-content: space-around;
            align-items: center;
        }
        input { 
            padding: 12px; 
            border-radius: 10px; 
            border: none; 
            font-size: 16px; 
            text-align: center; 
            width: 70%; 
            max-width: 200px; 
            margin-bottom: 10px;
        }

        /* --- Top 100 UI --- */
        .leaderboard-container {
            width: 95%;
            max-width: 500px;
            height: 60vh;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow-y: auto; /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÑ‡∏î‡πâ */
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .rank-item {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 10px;
            transition: 0.2s;
        }
        .rank-item:hover { background: rgba(255,255,255,0.2); }
        
        .rank-num { font-size: 20px; font-weight: bold; width: 40px; text-align: center; color: gold; }
        .rank-img { width: 40px; height: 40px; border-radius: 50%; margin: 0 15px; border: 2px solid #fff; }
        .rank-name { flex-grow: 1; text-align: left; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rank-score { font-weight: bold; color: var(--secondary); display: flex; align-items: center; gap: 5px; }

        /* --- Mobile Responsive Rules --- */
        @media (max-width: 600px) {
            h1 { font-size: 40px !important; }
            .lobby-box { flex-direction: column; gap: 20px; } /* Lobby ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .vs-text { margin: 10px 0; transform: rotate(90deg); }
            .navbar { padding: 10px; }
            .profile img { width: 35px; height: 35px; }
            .stats { padding: 5px 10px; font-size: 12px; }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏ß‡∏¢‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            #menu-buttons { display: flex; flex-direction: column; width: 100%; align-items: center; }
        }

        /* Scrollbar ‡∏™‡∏ß‡∏¢‡πÜ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    </style>
</head>
<body>

<div class="overlay"></div>

<div id="screen-login" class="screen active">
    <h1 style="font-size: 50px; text-shadow: 0 0 10px var(--primary);">X O Online</h1>
    <button class="btn" style="background: white; color: #444;" onclick="loginGoogle()">
        <i class="fab fa-google"></i> Login with Google
    </button>
</div>

<div id="screen-menu" class="screen">
    <div class="navbar">
        <div class="profile">
            <img id="user-img" src="">
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                <span id="user-name" style="font-weight:bold; font-size: 14px;">Loading...</span>
            </div>
        </div>
        <div class="stats">
            <span>ü™ô <b id="ui-coins">0</b></span>
            <span>‚≠ê <b id="ui-stars">0</b></span>
        </div>
    </div>

    <h1 style="font-size: 60px; text-shadow: 0 0 20px var(--primary); margin-top: 50px;">X O Game</h1>
    
    <div id="menu-buttons">
        <button class="btn btn-p" onclick="startBotGame()">
            <i class="fas fa-robot"></i> ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó
        </button>
        <button class="btn btn-s" onclick="showLobbyInput()">
            <i class="fas fa-user-friends"></i> ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
        </button>
        <button class="btn btn-gold" onclick="showTop100()">
            <i class="fas fa-trophy"></i> Top 100 Rank
        </button>
    </div>
    
    <div id="join-section" style="margin-top: 20px; display:none; text-align:center; width: 100%;">
        <input type="text" id="room-id-input" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (6 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="6" inputmode="numeric">
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="btn btn-s" style="width: auto;" onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
            <button class="btn" style="width: auto; background: #555;" onclick="closeJoinSection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
        <div style="margin-top:10px; color:#aaa;">- ‡∏´‡∏£‡∏∑‡∏≠ -</div>
        <button class="btn btn-p" onclick="createRoom()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
    </div>
</div>

<div id="screen-top100" class="screen">
    <h2 style="font-size: 30px; color: gold; margin-bottom: 10px;">üèÜ Top 100 Players</h2>
    <div class="leaderboard-container" id="leaderboard-list">
        <p style="text-align:center; margin-top:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
    <button class="btn" style="background: #444; margin-top: 20px;" onclick="backToMenu()">
        <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
    </button>
</div>

<div id="screen-lobby" class="screen">
    <h2 id="lobby-room-id" style="font-size: 24px; background:white; color:black; padding:5px 15px; border-radius:10px;">ID: ------</h2>
    <div class="lobby-box">
        <div style="text-align: center;">
            <img id="p1-img" src="" style="width:70px; height:70px; border-radius:50%; border:3px solid var(--primary);">
            <h3 id="p1-name" style="margin:5px 0;">Me</h3>
        </div>
        <div class="vs-text" style="font-size:30px; font-weight:bold; color:#aaa;">VS</div>
        <div style="text-align: center;">
            <img id="p2-img" src="" style="width:70px; height:70px; border-radius:50%; border:3px solid var(--secondary);">
            <h3 id="p2-name" style="margin:5px 0;">Waiting...</h3>
        </div>
    </div>
    <p id="lobby-status" style="margin-top:20px;">‡πÅ‡∏ä‡∏£‡πå ID ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</p>
    
    <button id="btn-start-friend" class="btn btn-p" style="display:none;" onclick="startGameFriend()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢!</button>
    <button class="btn" onclick="leaveRoom()" style="background:none; border:1px solid #fff;">‡∏≠‡∏≠‡∏Å</button>
</div>

<div id="screen-game" class="screen">
    <div class="navbar">
        <div style="font-size: 14px;">Me: <b id="game-p1-score">0</b></div>
        <div style="font-size: 18px; font-weight:bold; color:gold;">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="round-count">1</span></div>
        <div style="font-size: 14px;">Op: <b id="game-p2-score">0</b></div>
    </div>
    
    <div id="turn-indicator" style="margin-top: 60px; font-size: 20px; font-weight:bold;">‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: X</div>
    
    <div class="board" id="board">
        </div>
    
    <button class="btn" style="margin-top: 10px; background: #333; font-size:16px; width:auto;" onclick="backToMenu()">‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ / ‡∏≠‡∏≠‡∏Å</button>
</div>

<script type="module">
    // ------------------------------------------------------------------
    // 1. SETUP FIREBASE (‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    // ------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCwXPZCxFv2sUXV5QenHvEWQpNUg4yf3FU",
  authDomain: "xo-game-01.firebaseapp.com",
  projectId: "xo-game-01",
  storageBucket: "xo-game-01.firebasestorage.app",
  messagingSenderId: "1008413083804",
  appId: "1:1008413083804:web:ae631fcaaae66a789d8559",
  measurementId: "G-3H6SQMBQJF"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let currentRoomId = null;
    let mySymbol = 'X';
    let isBotMode = false;
    let boardState = Array(9).fill("");
    let round = 1;
    let scores = { x: 0, o: 0 };
    let gameActive = false;

    // --- Authentication ---
    window.loginGoogle = () => {
        signInWithPopup(auth, provider).catch((error) => {
            alert("Login Error: " + error.message);
        });
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            const userRef = ref(db, 'users/' + user.uid);
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤
            get(userRef).then((snapshot) => {
                const existingData = snapshot.val() || {};
                update(userRef, {
                    name: user.displayName,
                    photo: user.photoURL,
                    coins: existingData.coins || 100, // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ
                    stars: existingData.stars || 0    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ
                });
            });

            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    document.getElementById('user-name').innerText = data.name.split(' ')[0]; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏£‡∏Å
                    document.getElementById('user-img').src = data.photo;
                    document.getElementById('ui-coins').innerText = data.coins;
                    document.getElementById('ui-stars').innerText = data.stars;
                }
            });
            switchScreen('screen-menu');
        } else {
            switchScreen('screen-login');
        }
    });

    // --- Top 100 Logic (New Feature) ---
    window.showTop100 = () => {
        switchScreen('screen-top100');
        const listContainer = document.getElementById('leaderboard-list');
        listContainer.innerHTML = '<p style="text-align:center; margin-top:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

        // Query: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° stars, ‡πÄ‡∏≠‡∏≤ 100 ‡∏Ñ‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å)
        const topPlayersQuery = query(ref(db, 'users'), orderByChild('stars'), limitToLast(100));

        // ‡πÉ‡∏ä‡πâ onValue ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Realtime (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ã‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
        onValue(topPlayersQuery, (snapshot) => {
            listContainer.innerHTML = '';
            const players = [];
            
            snapshot.forEach((childSnapshot) => {
                players.push(childSnapshot.val());
            });

            // Firebase ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÅ‡∏ö‡∏ö ‡∏ô‡πâ‡∏≠‡∏¢->‡∏°‡∏≤‡∏Å ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏°‡∏≤‡∏Å->‡∏ô‡πâ‡∏≠‡∏¢
            players.reverse();

            if (players.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</p>';
                return;
            }

            players.forEach((player, index) => {
                const rank = index + 1;
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
                const div = document.createElement('div');
                div.className = 'rank-item';
                div.innerHTML = `
                    <div class="rank-num">${rank}</div>
                    <img src="${player.photo || 'https://via.placeholder.com/40'}" class="rank-img">
                    <div class="rank-name">${player.name || 'Unknown'}</div>
                    <div class="rank-score"><i class="fas fa-star" style="font-size:12px;"></i> ${player.stars || 0}</div>
                `;
                listContainer.appendChild(div);
            });
        });
    }

    // --- Multiplayer Room ---
    window.showLobbyInput = () => {
        document.getElementById('join-section').style.display = 'block';
        document.getElementById('menu-buttons').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    }
    
    window.closeJoinSection = () => {
        document.getElementById('join-section').style.display = 'none';
        document.getElementById('menu-buttons').style.display = 'flex';
    }

    window.createRoom = () => {
        const roomId = Math.floor(100000 + Math.random() * 900000).toString();
        const roomRef = ref(db, 'rooms/' + roomId);
        set(roomRef, {
            p1: { uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL },
            status: 'waiting',
            board: Array(9).fill(""),
            turn: 'X',
            round: 1,
            scores: { x: 0, o: 0 }
        });
        onDisconnect(roomRef).remove();
        enterLobby(roomId, 'owner');
    }

    window.joinRoom = () => {
        const roomId = document.getElementById('room-id-input').value;
        if (roomId.length !== 6) return alert("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö");
        
        const roomRef = ref(db, 'rooms/' + roomId);
        get(roomRef).then((snapshot) => {
            if (snapshot.exists() && snapshot.val().status === 'waiting') {
                update(roomRef, {
                    p2: { uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL },
                    status: 'ready'
                });
                enterLobby(roomId, 'guest');
            } else {
                alert("‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á");
            }
        });
    }

    function enterLobby(roomId, role) {
        currentRoomId = roomId;
        switchScreen('screen-lobby');
        document.getElementById('lobby-room-id').innerText = "ID: " + roomId;
        
        onValue(ref(db, 'rooms/' + roomId), (snapshot) => {
            const data = snapshot.val();
            if (!data) return backToMenu(); // ‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏¢

            if (data.p1) {
                document.getElementById('p1-name').innerText = data.p1.name.split(' ')[0];
                document.getElementById('p1-img').src = data.p1.photo;
            }
            if (data.p2) {
                document.getElementById('p2-name').innerText = data.p2.name.split(' ')[0];
                document.getElementById('p2-img').src = data.p2.photo;
                document.getElementById('lobby-status').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!";
                if (role === 'owner' && data.status === 'ready') {
                    document.getElementById('btn-start-friend').style.display = 'inline-block';
                }
            } else {
                document.getElementById('p2-name').innerText = "‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...";
                document.getElementById('p2-img').src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                document.getElementById('lobby-status').innerText = "‡πÅ‡∏ä‡∏£‡πå ID: " + roomId + " ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô";
            }

            if (data.status === 'playing') {
                startGameUI(data, role === 'owner' ? 'X' : 'O');
                updateBoardUI(data.board, data.turn, data.scores, data.round);
            }
        });
    }

    window.startGameFriend = () => {
        update(ref(db, 'rooms/' + currentRoomId), { status: 'playing' });
    }

    // --- Game Logic ---
    function startGameUI(roomData, symbol) {
        switchScreen('screen-game');
        mySymbol = symbol;
        isBotMode = false;
        createBoard();
    }
    
    window.startBotGame = () => {
        isBotMode = true;
        mySymbol = 'X';
        boardState = Array(9).fill("");
        round = 1;
        scores = { x: 0, o: 0 };
        gameActive = true;
        switchScreen('screen-game');
        createBoard();
        updateBoardUI(boardState, 'X', scores, round);
    }

    function createBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        for(let i=0; i<9; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.index = i;
            // ‡πÉ‡∏™‡πà Touch event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            cell.onclick = () => handleCellClick(i);
            board.appendChild(cell);
        }
    }

    function handleCellClick(index) {
        if (isBotMode) {
            if (!gameActive || boardState[index] !== "" || mySymbol !== 'X') return;
            makeMoveLocal(index, 'X');
            if (gameActive) setTimeout(botMove, 500);
        } else {
             // Online Logic (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
             get(ref(db, 'rooms/' + currentRoomId)).then((snap) => {
                 const data = snap.val();
                 if (data.board[index] === "" && data.turn === mySymbol) {
                     let newBoard = [...data.board];
                     newBoard[index] = mySymbol;
                     let nextTurn = mySymbol === 'X' ? 'O' : 'X';
                     
                     let winner = checkWin(newBoard);
                     let newScores = {...data.scores};
                     let newRound = data.round;
                     let resetBoard = false;

                     if (winner) {
                         winner === 'X' ? newScores.x++ : newScores.o++;
                         if(newScores.x >= 3 || newScores.o >= 3) {
                             endMatchOnline(winner === mySymbol);
                             return;
                         }
                         newRound++;
                         resetBoard = true;
                     } else if (!newBoard.includes("")) {
                         newRound++;
                         resetBoard = true;
                     }

                     update(ref(db, 'rooms/' + currentRoomId), {
                         board: resetBoard ? Array(9).fill("") : newBoard,
                         turn: nextTurn,
                         scores: newScores,
                         round: newRound
                     });
                 }
             });
        }
    }

    function updateBoardUI(board, turn, currentScores, currentRound) {
        const cells = document.querySelectorAll('.cell');
        board.forEach((val, idx) => {
            cells[idx].className = `cell ${val ? val.toLowerCase() : ''}`;
            cells[idx].innerText = val;
        });
        document.getElementById('turn-indicator').innerText = `‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: ${turn}`;
        document.getElementById('round-count').innerText = currentRound;
        
        let p1S = mySymbol == 'X' ? currentScores.x : currentScores.o;
        let p2S = mySymbol == 'X' ? currentScores.o : currentScores.x;
        if(isBotMode) { p1S = scores.x; p2S = scores.o; }

        document.getElementById('game-p1-score').innerText = p1S;
        document.getElementById('game-p2-score').innerText = p2S;
    }

    // --- Helpers & Logic ---
    function checkWin(board) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for (let c of wins) if (board[c[0]] && board[c[0]] === board[c[1]] && board[c[0]] === board[c[2]]) return board[c[0]];
        return null;
    }

    function makeMoveLocal(index, symbol) {
        boardState[index] = symbol;
        let winner = checkWin(boardState);
        if (winner) {
            winner === 'X' ? scores.x++ : scores.o++;
            if (scores.x >= 3 || scores.o >= 3) {
                gameActive = false;
                giveRewards(scores.x >= 3, 'bot');
            } else {
                resetBoardLocal();
            }
        } else if (!boardState.includes("")) {
            resetBoardLocal();
        } else {
            updateBoardUI(boardState, symbol==='X'?'O':'X', scores, round);
        }
    }

    function botMove() {
        if(!gameActive) return;
        let empty = boardState.map((v, i) => v === "" ? i : null).filter(v => v !== null);
        if (empty.length > 0) makeMoveLocal(empty[Math.floor(Math.random() * empty.length)], 'O');
    }

    function resetBoardLocal() {
        if (!gameActive) return;
        round++;
        boardState.fill("");
        updateBoardUI(boardState, 'X', scores, round);
    }

    function endMatchOnline(isWin) {
         giveRewards(isWin, 'friend');
         if(currentRoomId) remove(ref(db, 'rooms/' + currentRoomId));
    }

    function giveRewards(isWin, mode) {
        let starReward = 0;
        let coinReward = 0;
        let msg = "";

        if (mode === 'bot') {
            if (isWin) { starReward = 2; msg = "‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏ó! ‡πÑ‡∏î‡πâ 2 ‡∏î‡∏≤‡∏ß ‚≠ê‚≠ê"; }
            else msg = "‡πÅ‡∏û‡πâ‡∏ö‡∏≠‡∏ó!";
        } else {
            if (isWin) { starReward = 2; coinReward = 50; msg = "‡∏ä‡∏ô‡∏∞! ‡πÑ‡∏î‡πâ 2 ‡∏î‡∏≤‡∏ß 50 Coins"; }
            else { starReward = 1; coinReward = 10; msg = "‡πÅ‡∏û‡πâ! ‡πÑ‡∏î‡πâ 1 ‡∏î‡∏≤‡∏ß 10 Coins"; }
        }
        
        alert(msg);
        
        const userRef = ref(db, 'users/' + currentUser.uid);
        get(userRef).then(snap => {
            const data = snap.val();
            update(userRef, {
                coins: (data.coins || 0) + coinReward,
                stars: (data.stars || 0) + starReward
            });
        });
        backToMenu();
    }

    window.backToMenu = () => {
        gameActive = false;
        currentRoomId = null;
        switchScreen('screen-menu');
        document.getElementById('join-section').style.display = 'none';
        document.getElementById('menu-buttons').style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
    }
    
    window.leaveRoom = () => {
        if(currentRoomId) remove(ref(db, 'rooms/' + currentRoomId));
        backToMenu();
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>

</body>
</html>