<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X O Gemegame - Online Real</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
        :root { --primary: #ff0055; --secondary: #00d2ff; --bg: #1a1a2e; }
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0; background: url('https://images.unsplash.com/photo-1614726365723-49cfae967d68?q=80&w=2000') center/cover fixed;
            color: white; height: 100vh; overflow: hidden;
        }
        .overlay { position: fixed; inset: 0; background: rgba(15, 15, 25, 0.9); z-index: -1; }
        .screen { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; animation: fade 0.5s; }
        .active { display: flex; }
        @keyframes fade { from {opacity:0} to {opacity:1} }

        /* UI Elements */
        .btn { padding: 15px 30px; font-size: 20px; border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; font-weight: bold; margin: 10px; }
        .btn-p { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(255,0,85,0.4); }
        .btn-s { background: var(--secondary); color: white; box-shadow: 0 5px 15px rgba(0,210,255,0.4); }
        .btn:hover { transform: scale(1.05); }
        
        /* Navbar */
        .navbar { position: absolute; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; box-sizing: border-box; }
        .profile { display: flex; align-items: center; gap: 10px; }
        .profile img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid white; }
        .stats { display: flex; gap: 15px; background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 20px; }

        /* Board */
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; margin-top: 20px; }
        .cell { width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 50px; cursor: pointer; }
        .cell.x { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .cell.o { color: var(--secondary); text-shadow: 0 0 10px var(--secondary); }

        /* Lobby */
        .lobby-box { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); display: flex; width: 80%; max-width: 800px; }
        .lobby-side { flex: 1; text-align: center; padding: 20px; }
        .vs-text { font-size: 40px; font-weight: bold; align-self: center; }
        input { padding: 10px; border-radius: 5px; border: none; font-size: 16px; text-align: center; }
    </style>
</head>
<body>

<div class="overlay"></div>

<div id="screen-login" class="screen active">
    <h1>X O Game Online</h1>
    <button class="btn" style="background: white; color: #444;" onclick="loginGoogle()">
        <i class="fab fa-google"></i> Login with Google
    </button>
</div>

<div id="screen-menu" class="screen">
    <div class="navbar">
        <div class="profile">
            <img id="user-img" src="">
            <span id="user-name">Loading...</span>
        </div>
        <div class="stats">
            <span>ü™ô <b id="ui-coins">0</b></span>
            <span>‚≠ê <b id="ui-stars">0</b></span>
        </div>
    </div>
    <h1 style="font-size: 60px; text-shadow: 0 0 20px var(--primary);">X O Gemegame</h1>
    <div>
        <button class="btn btn-p" onclick="startBotGame()">ü§ñ ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó</button>
        <button class="btn btn-s" onclick="showLobbyInput()">üë• ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
    </div>
    
    <div id="join-section" style="margin-top: 20px; display:none;">
        <input type="text" id="room-id-input" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô" maxlength="6">
        <button class="btn btn-s" style="padding: 10px 20px;" onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
        <br><br>
        <button class="btn btn-p" onclick="createRoom()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
    </div>
</div>

<div id="screen-lobby" class="screen">
    <h2 id="lobby-room-id">ID: ------</h2>
    <div class="lobby-box">
        <div class="lobby-side">
            <img id="p1-img" src="" style="width:80px; height:80px; border-radius:50%;">
            <h3 id="p1-name">Waiting...</h3>
        </div>
        <div class="vs-text">VS</div>
        <div class="lobby-side">
            <img id="p2-img" src="" style="width:80px; height:80px; border-radius:50%;">
            <h3 id="p2-name">Waiting...</h3>
        </div>
    </div>
    <p id="lobby-status">‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...</p>
    <button id="btn-start-friend" class="btn btn-p" style="display:none;" onclick="startGameFriend()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    <button class="btn" onclick="leaveRoom()">‡∏≠‡∏≠‡∏Å</button>
</div>

<div id="screen-game" class="screen">
    <div class="navbar">
        <div class="profile">
            <span id="game-p1-score">Me (X): 0</span>
        </div>
        <div style="font-size: 24px;">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="round-count">1</span></div>
        <div class="profile">
            <span id="game-p2-score">Opponent (O): 0</span>
        </div>
    </div>
    
    <div id="turn-indicator" style="margin-top: 60px; font-size: 24px;">‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: X</div>
    
    <div class="board" id="board">
        </div>
    <button class="btn" style="margin-top: 20px; background: #444;" onclick="backToMenu()">‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ / ‡∏≠‡∏≠‡∏Å</button>
</div>

<script type="module">
    // ------------------------------------------------------------------
    // 1. SETUP FIREBASE (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!)
    // ------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCwXPZCxFv2sUXV5QenHvEWQpNUg4yf3FU",
  authDomain: "xo-game-01.firebaseapp.com",
  projectId: "xo-game-01",
  storageBucket: "xo-game-01.firebasestorage.app",
  messagingSenderId: "1008413083804",
  appId: "1:1008413083804:web:ae631fcaaae66a789d8559",
  measurementId: "G-3H6SQMBQJF"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
    let currentUser = null;
    let currentRoomId = null;
    let mySymbol = 'X';
    let isBotMode = false;
    let boardState = Array(9).fill("");
    let round = 1;
    let scores = { x: 0, o: 0 };
    let gameActive = false;

    // ------------------------------------------------------------------
    // 2. AUTHENTICATION & DATA
    // ------------------------------------------------------------------
    window.loginGoogle = () => {
        signInWithPopup(auth, provider).catch(console.error);
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Database ‡∏¢‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á
            const userRef = ref(db, 'users/' + user.uid);
            get(userRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    set(userRef, {
                        name: user.displayName,
                        photo: user.photoURL,
                        coins: 100,
                        stars: 0
                    });
                }
            });
            
            // Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Coins/Stars ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    document.getElementById('user-name').innerText = data.name;
                    document.getElementById('user-img').src = data.photo;
                    document.getElementById('ui-coins').innerText = data.coins;
                    document.getElementById('ui-stars').innerText = data.stars;
                }
            });

            switchScreen('screen-menu');
        } else {
            switchScreen('screen-login');
        }
    });

    // ------------------------------------------------------------------
    // 3. MULTIPLAYER ROOM SYSTEM
    // ------------------------------------------------------------------
    window.showLobbyInput = () => {
        document.getElementById('join-section').style.display = 'block';
    }

    window.createRoom = () => {
        const roomId = Math.floor(100000 + Math.random() * 900000).toString();
        const roomRef = ref(db, 'rooms/' + roomId);
        
        set(roomRef, {
            p1: { uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL },
            status: 'waiting',
            board: Array(9).fill(""),
            turn: 'X',
            round: 1,
            scores: { x: 0, o: 0 }
        });

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏´‡∏•‡∏∏‡∏î ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á (‡∏Å‡∏±‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á)
        onDisconnect(roomRef).remove();
        
        enterLobby(roomId, 'owner');
    }

    window.joinRoom = () => {
        const roomId = document.getElementById('room-id-input').value;
        if (roomId.length !== 6) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å");

        const roomRef = ref(db, 'rooms/' + roomId);
        get(roomRef).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                if (data.status === 'waiting') {
                    update(roomRef, {
                        p2: { uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL },
                        status: 'ready'
                    });
                    enterLobby(roomId, 'guest');
                } else {
                    alert("‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà");
                }
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ");
            }
        });
    }

    function enterLobby(roomId, role) {
        currentRoomId = roomId;
        switchScreen('screen-lobby');
        document.getElementById('lobby-room-id').innerText = "ID: " + roomId;
        
        const roomRef = ref(db, 'rooms/' + roomId);
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á (Realtime!)
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return; // ‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏ö

            // Update Lobby UI
            if (data.p1) {
                document.getElementById('p1-name').innerText = data.p1.name;
                document.getElementById('p1-img').src = data.p1.photo;
            }
            if (data.p2) {
                document.getElementById('p2-name').innerText = data.p2.name;
                document.getElementById('p2-img').src = data.p2.photo;
                document.getElementById('lobby-status').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!";
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà
                if (role === 'owner' && data.status === 'ready') {
                    document.getElementById('btn-start-friend').style.display = 'inline-block';
                }
            } else {
                 document.getElementById('p2-name').innerText = "‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...";
                 document.getElementById('p2-img').src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            }

            // ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô playing ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°
            if (data.status === 'playing') {
                startGameUI(data, role === 'owner' ? 'X' : 'O'); // ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô X ‡πÄ‡∏™‡∏°‡∏≠ (‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô)
            }
            
            // Sync Game Board (‡∏Ç‡∏ì‡∏∞‡πÄ‡∏•‡πà‡∏ô)
            if (data.status === 'playing') {
                updateBoardUI(data.board, data.turn, data.scores, data.round);
            }
        });
    }

    window.startGameFriend = () => {
        update(ref(db, 'rooms/' + currentRoomId), { status: 'playing' });
    }

    // ------------------------------------------------------------------
    // 4. GAMEPLAY LOGIC (Online & Bot)
    // ------------------------------------------------------------------
    function startGameUI(roomData, symbol) {
        switchScreen('screen-game');
        mySymbol = symbol;
        isBotMode = false;
        createBoard();
    }
    
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bot Mode (Local Logic)
    window.startBotGame = () => {
        isBotMode = true;
        mySymbol = 'X'; // ‡∏Ñ‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô X ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏≠‡∏ó‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
        boardState = Array(9).fill("");
        round = 1;
        scores = { x: 0, o: 0 };
        gameActive = true;
        
        switchScreen('screen-game');
        createBoard();
        updateBoardUI(boardState, 'X', scores, round);
    }

    function createBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        for(let i=0; i<9; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.index = i;
            cell.onclick = () => handleCellClick(i);
            board.appendChild(cell);
        }
    }

    function handleCellClick(index) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
        if (isBotMode) {
            if (!gameActive || boardState[index] !== "" || mySymbol !== 'X') return; // X ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô
            makeMoveLocal(index, 'X');
            if (gameActive) setTimeout(botMove, 500);
        } else {
            // Online Mode
            // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å snapshot ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
             get(ref(db, 'rooms/' + currentRoomId)).then((snap) => {
                 const data = snap.val();
                 if (data.board[index] === "" && data.turn === mySymbol) {
                     let newBoard = [...data.board];
                     newBoard[index] = mySymbol;
                     let nextTurn = mySymbol === 'X' ? 'O' : 'X';
                     
                     // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á Server Logic (Client ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó)
                     let winner = checkWin(newBoard);
                     let newScores = {...data.scores};
                     let newRound = data.round;
                     let resetBoard = false;

                     if (winner) {
                         // ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ä‡∏ô‡∏∞‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
                         if(winner === 'X') newScores.x++;
                         else newScores.o++;
                         
                         if(newScores.x >= 3 || newScores.o >= 3) {
                             // ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏ç‡πà (Match Over)
                             endMatchOnline(winner === mySymbol);
                             return;
                         } else {
                             // ‡∏à‡∏ö‡∏£‡∏≠‡∏ö‡∏¢‡πà‡∏≠‡∏¢
                             newRound++;
                             resetBoard = true;
                         }
                     } else if (!newBoard.includes("")) {
                         // ‡πÄ‡∏™‡∏°‡∏≠
                         newRound++;
                         resetBoard = true;
                     }

                     update(ref(db, 'rooms/' + currentRoomId), {
                         board: resetBoard ? Array(9).fill("") : newBoard,
                         turn: nextTurn, // ‡∏Ñ‡∏ô‡∏ä‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô (‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏•‡∏±‡∏ö)
                         scores: newScores,
                         round: newRound
                     });
                 }
             });
        }
    }

    // --- Update UI from State ---
    function updateBoardUI(board, turn, currentScores, currentRound) {
        const cells = document.querySelectorAll('.cell');
        board.forEach((val, idx) => {
            cells[idx].className = `cell ${val ? val.toLowerCase() : ''}`;
            cells[idx].innerText = val;
        });

        document.getElementById('turn-indicator').innerText = `‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: ${turn}`;
        document.getElementById('round-count').innerText = currentRound;
        document.getElementById('game-p1-score').innerText = `Me: ${isBotMode ? scores.x : (mySymbol=='X' ? currentScores.x : currentScores.o)}`;
        document.getElementById('game-p2-score').innerText = `Opponent: ${isBotMode ? scores.o : (mySymbol=='X' ? currentScores.o : currentScores.x)}`;
    }

    // --- Logic ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á Bot ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ Online) ---
    function checkWin(board) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for (let combo of wins) {
            if (board[combo[0]] && board[combo[0]] === board[combo[1]] && board[combo[0]] === board[combo[2]]) {
                return board[combo[0]];
            }
        }
        return null;
    }

    // --- Bot Logic ---
    function makeMoveLocal(index, symbol) {
        boardState[index] = symbol;
        let winner = checkWin(boardState);
        
        if (winner) {
            if (winner === 'X') scores.x++; else scores.o++;
            checkMatchOver();
            resetBoardLocal();
        } else if (!boardState.includes("")) {
            // Draw
            resetBoardLocal();
        } else {
             updateBoardUI(boardState, symbol==='X'?'O':'X', scores, round);
        }
    }

    function botMove() {
        if(!gameActive) return;
        let emptyIndices = boardState.map((v, i) => v === "" ? i : null).filter(v => v !== null);
        if (emptyIndices.length > 0) {
            let rand = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
            makeMoveLocal(rand, 'O');
        }
    }

    function resetBoardLocal() {
        if (!gameActive) return;
        round++;
        boardState.fill("");
        updateBoardUI(boardState, 'X', scores, round);
    }
    
    function checkMatchOver() {
        if (scores.x >= 3 || scores.o >= 3) {
            gameActive = false;
            let isWin = scores.x >= 3;
            // ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
            giveRewards(isWin, 'bot');
        }
    }

    function endMatchOnline(isWin) {
         // ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ Server function ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö Client-side ‡∏á‡πà‡∏≤‡∏¢‡πÜ
         giveRewards(isWin, 'friend');
         // ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á
         if(currentRoomId) remove(ref(db, 'rooms/' + currentRoomId));
    }

    // ------------------------------------------------------------------
    // 5. REWARDS SYSTEM
    // ------------------------------------------------------------------
    function giveRewards(isWin, mode) {
        let coinReward = 0;
        let starReward = 0;
        let msg = "";

        if (mode === 'bot') {
            if (isWin) { starReward = 2; msg = "‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏ó! ‡πÑ‡∏î‡πâ 2 ‡∏î‡∏≤‡∏ß"; }
            else { msg = "‡πÅ‡∏û‡πâ‡∏ö‡∏≠‡∏ó ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢"; }
        } else {
            if (isWin) { starReward = 2; coinReward = 50; msg = "‡∏ä‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡πÑ‡∏î‡πâ 2 ‡∏î‡∏≤‡∏ß 50 Coins"; }
            else { starReward = 1; coinReward = 10; msg = "‡πÅ‡∏û‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏õ‡∏•‡∏≠‡∏ö‡πÉ‡∏à 1 ‡∏î‡∏≤‡∏ß 10 Coins"; }
        }

        alert(msg);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Database
        const userRef = ref(db, 'users/' + currentUser.uid);
        get(userRef).then(snap => {
            const data = snap.val();
            update(userRef, {
                coins: data.coins + coinReward,
                stars: data.stars + starReward
            });
        });

        backToMenu();
    }

    window.backToMenu = () => {
        gameActive = false;
        currentRoomId = null;
        switchScreen('screen-menu');
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ UI
        document.getElementById('join-section').style.display = 'none';
        document.getElementById('lobby-status').innerText = "‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...";
        document.getElementById('p2-name').innerText = "Waiting...";
        document.getElementById('p2-img').src = "";
    }
    
    window.leaveRoom = () => {
        if(currentRoomId) {
            // ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á
             remove(ref(db, 'rooms/' + currentRoomId));
        }
        backToMenu();
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>

</body>
</html>